<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">

    <link href="https://cdnjs.cloudflare.com/ajax/libs/c3/0.4.10/c3.min.css" rel="stylesheet">

    <style type="text/css">
    	.donut {
		  width: 220px;
		  height: 220px;
		}


		/* don't do anything fancy when hovering */

		.donut .c3-chart-arcs-title {
		  fill: black;
		  font-size: 4.5em;
		}

    </style>
</head>

<body>
	<div class="donut" id="cpu_chart"></div>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/c3/0.4.10/c3.min.js"></script>
	<script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
    <script type="text/javascript">
// Avg 50.507 , 80-pctile 62.28 , 95-pctile 80
// Input: attribute name, test name, id

function createDonutChart(data, testName, donut_id) {

  var getRemain = function(d, name) {
    return ['remain', 1 - d[name][1]]
  }

  var getAllData = function(d) {
    // Sequence: remain, data1, data2, data3
    var keys = Object.keys(d);
    if (keys.length === 0) {
      return [];
    }
    var data = [];
    for (i = 0; i < keys.length; i++) {
      name = keys[i];
      data.push(d[name]);
    }
    var name = keys[0];
    data.push(['remain', 1 - d[name][1]]);
    return data
  }

  var allDataNames = Object.keys(data);
  var defaultName = allDataNames[0];
  var defaultLegend = data[defaultName][0];
  var legendToName = {}
  Object.keys(data).forEach(function(name) {
  	legendToName[data[name][0]] = name
  })

  var allLegendsExcept = function(legend) {
    return Object.keys(legendToName).filter(function(elem) {
      return elem !== legend
    });
  }

  var allData = getAllData(data)

  var getPatterns = function(data) {
    // remain: '#D3D3D3'
    s = data.map(function(d) {
      if (d[0] === "remain") {
        return '#D3D3D3'
      } else if (d[1] < 0.4) {
        return '#2CA02C' // green
      } else if (d[1] < 0.7) {
        return '#1f77b4' // blue
      } else {
        return '#d62728' //red
      }
    })
    return s
  }

  var chartDisplay = function(name) {
    chart.load({
      columns: [getRemain(data, name)],
      order: null
    });
    var legend = data[name][0]
    chart.show([legend])
    chart.hide(allLegendsExcept(legend));
  }

  var chart = c3.generate({
  	bindto: '#' + donut_id,
    data: {
      columns: allData,
      type: 'donut',
      onclick: function(d, i) {},
      hide: allLegendsExcept(defaultLegend),
      order: null
    },
    color: {
      pattern: getPatterns(allData)
    },
    donut: {
      title: data[defaultName][1] * 100,
      label: {
        show: false
      },
      // title: Math.round(percentage * 100),
      width: 15,
      expand: true,
    },
    legend: {
      hide: ['remain'],
      item: {
        onclick: function(id) {},
        onmouseover: function(name) {
          name = legendToName[name];
          chartDisplay(name);
          d3.select("#" + donut_id + ' .c3-chart-arcs-title').node().innerHTML = data[name][1] * 100;
        },
      },
    },
  });

  // baseline text properly
  d3.select(".c3-chart-arcs-title")
    .attr("dy", "0.15em")

  // add percentage symbol
  d3.select(".c3-chart-arcs")
    .append("text")
    .text("%")
    .attr("font-size", "15px")
    .attr("dy", "-0.4em")
    .attr("dx", "2em")
}

var data = {
    data1: ['Average', 0.3],
    data2: ['80 Percentile', 0.65],
    data3: ['95 Percentile', 0.9]
}


createDonutChart(data, "CPU", "cpu_chart")

// export { createDonutChart }
    </script>
</body>

</html>